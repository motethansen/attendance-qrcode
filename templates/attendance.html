<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>Attendance</h1>
    <p>Current time: {{ timestamp }}</p>
    <form id="attendance-form" action="{{ url_for('submit_attendance') }}" method="post">
        <label for="student_id">Student ID:</label>
        <input type="text" id="student_id" name="student_id" required>
        <input type="hidden" name="timestamp" value="{{ timestamp }}">
        <button type="submit">Submit Attendance</button>
    </form>
    <p id="location-status">Checking location...</p>

    <script>
        const ACCEPTED_LAT = {{ accepted_lat }};
        const ACCEPTED_LON = {{ accepted_lon }};
        const ACCEPTED_RADIUS = {{ accepted_radius }};

        function getLocation() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            resolve(position);
                        },
                        error => {
                            console.error("Error getting location:", error);
                            reject(error);
                        }
                    );
                } else {
                    console.log("Geolocation is not supported by this browser.");
                    reject(new Error("Geolocation not supported"));
                }
            });
        }

        function checkLocation(lat, lon) {
            const R = 6371000; // Earth radius in meters
            const phi1 = ACCEPTED_LAT * Math.PI / 180;
            const phi2 = lat * Math.PI / 180;
            const deltaPhi = (lat - ACCEPTED_LAT) * Math.PI / 180;
            const deltaLambda = (lon - ACCEPTED_LON) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c;

            return distance <= ACCEPTED_RADIUS;
        }

        document.addEventListener("DOMContentLoaded", () => {
            getLocation()
                .then(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    if (checkLocation(lat, lon)) {
                        document.getElementById('location-status').textContent = "Location verified.";
                        document.getElementById('attendance-form').style.display = 'block';
                    } else {
                        window.location.href = "{{ url_for('wrong_location') }}";
                    }
                })
                .catch(error => {
                    console.error("Failed to get location:", error);
                    document.getElementById('location-status').textContent = "Failed to get location. Please enable location services and refresh the page.";
                });
        });
    </script>
</body>
</html>
